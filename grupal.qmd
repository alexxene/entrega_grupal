---
title: "Entrega grupal"
author: "Iratxe Valero Ochoa (DNI:02724987Q), 
        Ángela García Muñoz (DNI:01840008P),
        Javier Ruiz (DNI:25449733A), 
        Javier Muñoz Zacarés (DNI:55136745H),
        Xin Yue Huang (NIE:Y8908945R),
        Alexandra Mihaela Ene (NIE: Y3510242L),
        María Belén Lavanda Rocano (DNI:02723226A) "
format:
  revealjs:
    theme: [style.scss]
    embed-resources: true
execute: 
  echo: true
---

```{r}
rm(list = ls())
library(tidyverse)
library(dplyr)
library(glue)
library(forcats)
library(lubridate)
```

------------------------------------------------------------------------

```{r}
# NO TOQUES NADA
election_data <- read_csv(file = "./data/datos_elecciones_brutos.csv")
cod_mun <- read_csv(file = "./data/cod_mun.csv")
surveys <- read_csv(file = "./data/historical_surveys.csv")
abbrev <- read_csv(file = "./data/siglas.csv")
```

------------------------------------------------------------------------

<<<<<<< Updated upstream
## 

=======
>>>>>>> Stashed changes
Eliminar las columnas de election_data que tienen valores fijos (comprobado con unique):

```{r}
# Quitamos la variable "mes" debido a que sólamente hay una elección por año y ocurre en ese mismo mes por lo que saber el mes no nos interesa.
election_data <-election_data |>
  select(-c(tipo_eleccion,codigo_distrito_electoral,vuelta, mes))

election_data <- election_data|> 
  mutate(id_municipio = glue("{codigo_provincia}{codigo_municipio}")) |> 
  relocate(id_municipio, .before=codigo_ccaa)

election_data <- election_data |> 
  select(-c(codigo_ccaa,codigo_provincia,codigo_municipio))
```

Eliminar columnas de surveys sin info + encuestas a pie de urna y anteriores a 2016

```{r}
surveys <- surveys|> select(-type_survey) |>
  filter(exit_poll==FALSE) |> 
  filter((field_date_to-field_date_from)>0) |> 
  filter(size>=500 & !is.na(size)) |> 
  filter(date_elec>'2008-1-1')
```


```{r}
election_data <- 
  election_data |> 
  pivot_longer(cols = "BERDEAK-LOS VERDES":"COALICIÓN POR MELILLA", names_to = "partidos", values_to = "votos", values_drop_na = TRUE )

```

------------------------------------------------------------------------

Utilizamos la variable partidos para agrupar todos ellos en solo 12: "PP" "UP" "PSOE" "PNV" "Cs" "ERC" "CIU" "MP" "VOX" "BNG" "EH-BILDU" "OTROS"

```{r}
resumen <- election_data |> mutate('siglas' = case_when(
  str_detect(partidos, "EZKER BA|ENTESA|PODEM|IZQUIERDA UNIDA|ESQUERRA UNI|ESQUERDA UNI") ~ "UP",
  str_detect(partidos, "PP|PARTIDO POPULAR|PARTIT POPULAR") ~ "PP",
  str_detect(partidos, "PNV|PARTIDO NACIONALISTA VASCO") ~ "PNV",
  str_detect(partidos, "PSOE|PSC|PARTIDO SOCIALISTA|PARTIT SOCIALISTA") ~ "PSOE",
  str_detect(partidos, "PAÍS|COMPROMÍS") ~ "MP",
  str_detect(partidos, "VOX") ~ "VOX",
  str_detect(partidos, "ARALAR|EUSKO|EUSKAL HERRI|BILDU") ~ "EH-BILDU",
  str_detect(partidos, "ERC|ESQUERRA REPU") ~ "ERC",
  str_detect(partidos, "BNG|BLOQUE") ~ "BNG",
  str_detect(partidos, "CIUTADANS|PARTIDO DE LA CIU") ~ "Cs",
  str_detect(partidos, "CONVERGENCIA I UNIÓ|CONVERGÈNCIA I UNIÓ|CONVERGENTS") ~ "CIU", 
  TRUE ~ "OTROS"
))
(unique(resumen$siglas))
```

<<<<<<< Updated upstream
```{r}

# ¿Qué partido fue el ganador en los municipios con más de 100.000 habitantes (censo) en cada una de las elecciones?

ganadores <- resumen |> 
  filter(censo > 100000) |> 
  group_by(anno, id_municipio) |> 
  arrange(desc(votos)) |> 
  slice(1) |>  
  summarise(partido_ganador = siglas,  
    max_votos = votos,       
    censo_municipio = censo) |> 
  ungroup()


```

=======
>>>>>>> Stashed changes
Añadimos gráfico de España con municipios de más de 100k habitantes

coloreados por los partidos que ganaron las elecciones en cada uno de los años electorales

```{r}

install.packages("mapSpain")
library(mapSpain)
mapa_mas100k_ganadores<-
mapSpain::esp_get_munic() |> 
    left_join(ganadores, by=c("LAU_CODE"="id_municipio")) |> 
    filter(anno=="2016")

ggplot(mapa_mas100k_ganadores)+
  geom_sf(aes(fill=partido_ganador),alpha=0.7, color="grey")+
  scale_fill_manual(
    #escogemos los colores correspondientes a los logos de cada partido
    values=c("PP"="#1A4CA0",
              "UP"="#542C85",
              "PSOE"="#D50000",
              "PNV"="#018B3F",
              "Cs"="#EB6109",
              "ERC"="#FFCD00",
              "CIU"="#1E3A5F",
              "MP"="#5A9A6E",
              "VOX"="#1D7A2A",
              "BNG"="#007A33",
              "EH-BILDU"="#4C9A2A",
              "OTROS"="pink",
              "NA"="gray"),
              na.value = "gray" )+
  theme_minimal()+
  labs(fill="partido_ganador",
       title="Partidos ganadores en municipios de más de cien mil habitantes")+
  theme(plot.title = element_text(hjust = 0.5),
        legend.position = "bottom")
#+
  #facet_wrap(~ anno)

```
